<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindMend - Mental Health Support System</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.7.1/gsap.min.js"></script>
    <style>
        :root {
            --primary-color: #003366;
            --secondary-color: #1b2735;
            --accent-color: #0056b3;
            --text-light: #ffffff;
            --text-dark: #2A2A2A;
            --card-bg: rgba(255, 255, 255, 0.95);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --button-gradient: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--button-gradient);
            color: var(--text-light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        header {
            position: relative;
            padding: 60px 20px;
            text-align: center;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
            box-shadow: 0 4px 30px var(--shadow-color);
            z-index: 1;
        }

        .hero-title {
            font-size: 4rem;
            font-weight: 700;
            margin-bottom: 20px;
            background: linear-gradient(120deg, #ffffff, #e0e0e0);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 2px 2px 10px rgba(0,0,0,0.2);
        }

        .hero-subtitle {
            font-size: 1.5rem;
            margin-bottom: 40px;
            opacity: 0.9;
        }

        .wellness-points {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--accent-color);
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: float 3s ease-in-out infinite;
        }

        .points-icon {
            font-size: 1.2em;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            padding: 50px;
            position: relative;
            z-index: 1;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .feature-card:hover::before {
            transform: translateX(100%);
        }

        .feature-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }

        .feature-icon {
            font-size: 3em;
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }

        .feature-card:hover .feature-icon {
            transform: scale(1.2);
        }

        .feature-title {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: var(--text-light);
        }

        .feature-description {
            font-size: 1em;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 20px;
        }

        .action-button {
            background: var(--button-gradient);
            color: var(--text-light);
            padding: 12px 25px;
            border-radius: 25px;
            border: none;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        .action-button:hover {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow-color);
        }

        .gamification-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: var(--accent-color);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            transform: rotate(15deg);
        }

        .rewards-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 15px;
            display: flex;
            gap: 15px;
            z-index: 1000;
        }

        .reward-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-size: 0.9em;
        }

        .streak-counter {
            color: #FFD700;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @media (max-width: 768px) {
            .hero-title {
                font-size: 2.5rem;
            }

            .features-grid {
                grid-template-columns: 1fr;
                padding: 20px;
            }

            .rewards-panel {
                flex-direction: column;
                gap: 10px;
            }
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--button-gradient);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loading-screen">
        <div class="loader"></div>
    </div>

    <div class="particles" id="particles-js"></div>

    <div class="wellness-points">
        <span class="points-icon">üåü</span>
        <span>1,250 Wellness Points</span>
    </div>

    <header>
        <h1 class="hero-title">MindMend</h1>
        <p class="hero-subtitle">Empowering Your Mental Well-being Journey</p>
    </header>

    <div class="features-grid">
        <div class="feature-card" data-aos="fade-up">
            <div class="gamification-badge">+50 pts/chat</div>
            <div class="feature-icon">ü§ñ</div>
            <h3 class="feature-title">AI Wellness Guide</h3>
            <p class="feature-description">Personalized support with our emotionally intelligent AI companion</p>
            <a href="chatbot.html" class="action-button">Start Chat</a>
        </div>

        <div class="feature-card" data-aos="fade-up" data-aos-delay="100">
            <div class="gamification-badge">+100 pts/session</div>
            <div class="feature-icon">üë•</div>
            <h3 class="feature-title">Support Circle</h3>
            <p class="feature-description">Connect with peers and professionals in a safe space</p>
            <a href="support_groups.html" class="action-button">Join Now</a>
        </div>

        <div class="feature-card" data-aos="fade-up" data-aos-delay="200">
            <div class="gamification-badge">Daily Streak!</div>
            <div class="feature-icon">üìä</div>
            <h3 class="feature-title">Mood & Progress</h3>
            <p class="feature-description">Track your journey with interactive insights</p>
            <a href="mood_tracker.html" class="action-button">Track Now</a>
        </div>

        <div class="feature-card" data-aos="fade-up" data-aos-delay="300">
            <div class="feature-icon">üßò</div>
            <h3 class="feature-title">Mindfulness Zone</h3>
            <p class="feature-description">Quick exercises for stress relief and focus</p>
            <a href="yoga_practice.html" class="action-button">Start Practice</a>
        </div>

        <div class="feature-card" data-aos="fade-up" data-aos-delay="400">
            <div class="gamification-badge">New Content!</div>
            <div class="feature-icon">üìö</div>
            <h3 class="feature-title">Resource Hub</h3>
            <p class="feature-description">Curated content for mental wellness</p>
            <a href="resource_library.html" class="action-button">Explore</a>
        </div>

        <div class="feature-card" data-aos="fade-up" data-aos-delay="500">
            <div class="feature-icon">üìä</div>
            <h3 class="feature-title">Institution Insights</h3>
            <p class="feature-description">Anonymous analytics for better support</p>
            <a href="institutional_dashboard.html" class="action-button">View Stats</a>
        </div>

        <div class="feature-card" data-aos="fade-up" data-aos-delay="600">
            <div class="gamification-badge">+75 pts/game</div>
            <div class="feature-icon">üéÆ</div>
            <h3 class="feature-title">Stress Booster Games</h3>
            <p class="feature-description">Fun interactive games to boost your mood</p>
            <a href="stress_booster_game.html" class="action-button">Play Now</a>
        </div>

        <div class="feature-card" data-aos="fade-up" data-aos-delay="700">
            <div class="gamification-badge">+25 pts/scan</div>
            <div class="feature-icon">üì∑</div>
            <h3 class="feature-title">Emotion Scanner</h3>
            <p class="feature-description">AI-powered facial expression analysis for mood detection</p>
            <button id="emotion-scanner-btn" class="action-button">Scan Now</button>
        </div>
    </div>

    <div class="rewards-panel">
        <div class="reward-item">
            <span>üî•</span>
            <span class="streak-counter">7 Day Streak!</span>
        </div>
        <div class="reward-item">
            <span>üéÅ</span>
            <span>3 Rewards Available</span>
        </div>
        <div class="reward-item">
            <span>üèÜ</span>
            <span>Level 5 Helper</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.13.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection@0.0.3"></script>
    <script src="https://cdn.jsdelivr.net/npm/deepface-js@0.0.4/dist/deepface.min.js"></script>
    <script>
        // Initialize AOS
        AOS.init({
            duration: 1000,
            once: true
        });

        // Particles.js configuration
        particlesJS('particles-js', {
            particles: {
                number: { value: 80, density: { enable: true, value_area: 800 } },
                color: { value: '#ffffff' },
                shape: { type: 'circle' },
                opacity: { value: 0.5, random: false },
                size: { value: 3, random: true },
                line_linked: {
                    enable: true,
                    distance: 150,
                    color: '#ffffff',
                    opacity: 0.4,
                    width: 1
                },
                move: {
                    enable: true,
                    speed: 2,
                    direction: 'none',
                    random: false,
                    straight: false,
                    out_mode: 'out',
                    bounce: false
                }
            },
            interactivity: {
                detect_on: 'canvas',
                events: {
                    onhover: { enable: true, mode: 'repulse' },
                    onclick: { enable: true, mode: 'push' },
                    resize: true
                }
            },
            retina_detect: true
        });

        // Loading screen
        window.addEventListener('load', () => {
            const loadingScreen = document.querySelector('.loading-screen');
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
                loadingScreen.style.display = 'none';
            }, 500);
        });

        // GSAP animations
        gsap.from('.hero-title', {
            duration: 1,
            y: 100,
            opacity: 0,
            ease: 'power4.out',
            delay: 0.5
        });

        gsap.from('.hero-subtitle', {
            duration: 1,
            y: 50,
            opacity: 0,
            ease: 'power4.out',
            delay: 0.8
        });

        gsap.from('.wellness-points', {
            duration: 1,
            x: 100,
            opacity: 0,
            ease: 'power4.out',
            delay: 1
        });

        // Gamification system
        let wellnessPoints = 1250;
        let streakDays = 7;

        function updatePoints(points) {
            wellnessPoints += points;
            document.querySelector('.wellness-points span:last-child').textContent = 
                `${wellnessPoints} Wellness Points`;
        }

        // Add hover effect to feature cards
        document.querySelectorAll('.feature-card').forEach(card => {
            card.addEventListener('mouseenter', () => {
                gsap.to(card.querySelector('.feature-icon'), {
                    scale: 1.2,
                    duration: 0.3
                });
            });

            card.addEventListener('mouseleave', () => {
                gsap.to(card.querySelector('.feature-icon'), {
                    scale: 1,
                    duration: 0.3
                });
            });
        });
        
        // Emotion Scanner Functionality
        const emotionScannerBtn = document.getElementById('emotion-scanner-btn');
        if (emotionScannerBtn) {
            emotionScannerBtn.addEventListener('click', openEmotionScanner);
        }
        
        function openEmotionScanner() {
            // Create modal for emotion scanner
            const modal = document.createElement('div');
            modal.className = 'emotion-modal';
            modal.innerHTML = `
                <div class="emotion-scanner-content">
                    <div class="scanner-header">
                        <h3>MindMend Emotion Scanner</h3>
                        <button class="close-button">&times;</button>
                    </div>
                    <div class="scanner-body">
                        <p>Our AI can analyze your facial expressions to detect your current emotional state.</p>
                        <div class="video-container">
                            <video id="emotion-video" playsinline autoplay></video>
                            <canvas id="emotion-canvas" style="display:none;"></canvas>
                            <div class="scanning-overlay">
                                <div class="scan-animation"></div>
                            </div>
                        </div>
                        <div class="emotion-result">
                            <div class="emotion-status">Ready to scan</div>
                            <div class="emotion-recommendation" style="display:none;"></div>
                        </div>
                        <button class="start-scan-button">Start Scan</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add styles for the modal
            const style = document.createElement('style');
            style.textContent = `
                .emotion-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                }
                
                .emotion-scanner-content {
                    background: white;
                    width: 90%;
                    max-width: 600px;
                    border-radius: 20px;
                    overflow: hidden;
                    color: var(--text-dark);
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                }
                
                .scanner-header {
                    background: var(--primary-color);
                    color: white;
                    padding: 1.5rem;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                
                .scanner-header h3 {
                    margin: 0;
                    font-size: 1.5rem;
                }
                
                .close-button {
                    background: none;
                    border: none;
                    color: white;
                    font-size: 1.8rem;
                    cursor: pointer;
                    line-height: 1;
                }
                
                .scanner-body {
                    padding: 1.5rem;
                    display: flex;
                    flex-direction: column;
                    gap: 1.5rem;
                }
                
                .video-container {
                    position: relative;
                    width: 100%;
                    height: 350px;
                    background: #f0f0f0;
                    overflow: hidden;
                    border-radius: 12px;
                }
                
                #emotion-video {
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                }
                
                .scanning-overlay {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    display: none;
                    pointer-events: none;
                }
                
                .scan-animation {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 5px;
                    background: linear-gradient(90deg, transparent, var(--accent-color), transparent);
                    animation: scan-line 2s linear infinite;
                }
                
                @keyframes scan-line {
                    0% { top: 0; }
                    100% { top: 100%; }
                }
                
                .emotion-result {
                    padding: 1.5rem;
                    border-radius: 12px;
                    background: #f8f8f8;
                    text-align: center;
                }
                
                .emotion-status {
                    font-weight: 500;
                    font-size: 1.1rem;
                    color: var(--text-dark);
                }
                
                .emotion-recommendation {
                    margin-top: 1rem;
                    padding: 1rem;
                    background: rgba(0, 86, 179, 0.1);
                    border-left: 4px solid var(--accent-color);
                    border-radius: 4px;
                    text-align: left;
                }
                
                .start-scan-button {
                    background: var(--accent-color);
                    color: white;
                    border: none;
                    padding: 1rem 2rem;
                    border-radius: 30px;
                    font-size: 1rem;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    align-self: center;
                }
                
                .start-scan-button:hover {
                    background: var(--primary-color);
                    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
                    transform: translateY(-2px);
                }
                
                .emotion-badge {
                    display: inline-block;
                    padding: 0.5rem 1rem;
                    border-radius: 20px;
                    font-weight: 600;
                    margin-top: 1rem;
                }
                
                .emotion-happy {
                    background: #c8e6c9;
                    color: #2e7d32;
                }
                
                .emotion-sad {
                    background: #bbdefb;
                    color: #1565c0;
                }
                
                .emotion-angry {
                    background: #ffcdd2;
                    color: #c62828;
                }
                
                .emotion-neutral {
                    background: #f5f5f5;
                    color: #616161;
                }
                
                .emotion-surprised {
                    background: #fff9c4;
                    color: #f57f17;
                }
            `;
            
            document.head.appendChild(style);
            
            // Handle close button
            const closeButton = modal.querySelector('.close-button');
            closeButton.addEventListener('click', () => {
                stopCamera();
                modal.remove();
                style.remove();
            });
            
            const video = document.getElementById('emotion-video');
            const emotionStatus = modal.querySelector('.emotion-status');
            const startScanButton = modal.querySelector('.start-scan-button');
            const emotionRecommendation = modal.querySelector('.emotion-recommendation');
            const scanningOverlay = modal.querySelector('.scanning-overlay');
            let stream = null;
            
            // Start camera when the button is clicked
            startScanButton.addEventListener('click', async () => {
                try {
                    if (startScanButton.textContent === 'Start Scan') {
                        // Load AI models first
                        const modelsLoaded = await loadModels();
                        if (!modelsLoaded) {
                            return; // Stop if models couldn't be loaded
                        }
                        
                        emotionStatus.textContent = 'Accessing camera...';
                        stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { facingMode: 'user' } 
                        });
                        
                        video.srcObject = stream;
                        startScanButton.textContent = 'Scanning...';
                        startScanButton.disabled = true;
                        
                        // Show scanning animation
                        scanningOverlay.style.display = 'block';
                        
                        // Start face detection after video is loaded
                        video.onloadedmetadata = function() {
                            setTimeout(() => {
                                detectEmotion();
                            }, 2000);
                        };
                    } else if (startScanButton.textContent === 'Scan Again') {
                        // Reset for another scan
                        emotionRecommendation.style.display = 'none';
                        scanningOverlay.style.display = 'block';
                        startScanButton.disabled = true;
                        startScanButton.textContent = 'Scanning...';
                        
                        // Start detection again
                        setTimeout(() => {
                            detectEmotion();
                        }, 1000);
                    } else {
                        // Close modal and add points
                        updatePoints(25); // Add points for completing a scan
                        stopCamera();
                        modal.remove();
                        style.remove();
                    }
                } catch (err) {
                    emotionStatus.textContent = 'Camera access denied. Please allow access to use this feature.';
                    console.error('Error accessing camera:', err);
                    startScanButton.disabled = false;
                    startScanButton.textContent = 'Start Scan';
                }
            });
            
            function stopCamera() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                scanningOverlay.style.display = 'none';
            }
            
            // Load advanced face detection models with DeepFace and BlazeFace
            async function loadModels() {
                try {
                    emotionStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading AI models...';
                    
                    // Load BlazeFace model (lightweight face detector)
                    window.blazeFaceModel = await blazeface.load();
                    
                    // Load facial landmark model for more detailed analysis
                    window.faceLandmarkModel = await facemesh.load({
                        maxFaces: 1 // We only need to analyze one face at a time
                    });
                    
                    // DeepFace will load its models on-demand
                    
                    emotionStatus.innerHTML = 'Advanced AI models loaded successfully!';
                    return true;
                } catch (error) {
                    console.error('Error loading advanced detection models:', error);
                    emotionStatus.innerHTML = 'Error loading AI models. Please try again later.';
                    return false;
                }
            }
            
            // This section has been replaced by the enhanceEmotionDetection function
            // which provides more nuanced emotion detection with DeepFace
            
            // Advanced emotion detection using DeepFace and BlazeFace
            async function detectEmotion() {
                const video = document.getElementById('emotion-video');
                
                try {
                    // Display processing message
                    emotionStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing facial expression...';
                    
                    // Check if models are loaded, if not load them
                    if (!window.blazeFaceModel) {
                        await loadModels();
                    }
                    
                    // Create a canvas to capture the current frame from video
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // Hide scanning overlay
                    scanningOverlay.style.display = 'none';
                    
                    // First, detect face using BlazeFace (faster detection)
                    const blazeFaceDetections = await window.blazeFaceModel.estimateFaces(video, false);
                    
                    if (blazeFaceDetections && blazeFaceDetections.length > 0) {
                        // Get face rectangle for DeepFace
                        const faceBox = {
                            x: Math.round(blazeFaceDetections[0].topLeft[0]),
                            y: Math.round(blazeFaceDetections[0].topLeft[1]),
                            width: Math.round(blazeFaceDetections[0].bottomRight[0] - blazeFaceDetections[0].topLeft[0]),
                            height: Math.round(blazeFaceDetections[0].bottomRight[1] - blazeFaceDetections[0].topLeft[1])
                        };
                        
                        // Get landmarks for more accurate analysis (optional)
                        const faceLandmarks = await window.faceLandmarkModel.estimateFaces({
                            input: video
                        });
                        
                        // Process with DeepFace for emotion detection
                        const deepFaceResult = await deepface.analyze(canvas.toDataURL(), {
                            actions: ['emotion']
                        });
                        
                        // Extract emotion data
                        const emotions = deepFaceResult.emotion;
                        
                        // Find the dominant emotion
                        let dominantEmotion = '';
                        let highestScore = 0;
                        
                        for (const [emotion, score] of Object.entries(emotions)) {
                            if (score > highestScore) {
                                highestScore = score;
                                dominantEmotion = emotion;
                            }
                        }
                        
                        // Enhanced emotion mapping with DeepFace's more accurate analysis
                        let detectedEmotion = dominantEmotion.charAt(0).toUpperCase() + dominantEmotion.slice(1);
                        const confidencePercent = Math.round(highestScore * 100);
                        
                        // Enhance detection by considering intensity ratios
                        const enhancedEmotion = enhanceEmotionDetection(emotions);
                        if (enhancedEmotion) {
                            detectedEmotion = enhancedEmotion;
                        }
                        
                        // Determine emotion class for styling
                        let emotionClass = 'emotion-' + dominantEmotion.toLowerCase();
                        if (!['happy', 'sad', 'angry', 'neutral', 'surprise', 'disgust', 'fear'].includes(dominantEmotion.toLowerCase())) {
                            emotionClass = 'emotion-neutral'; // Default for emotions without specific styling
                        }
                        
                        // Update status with detailed emotion analysis
                        emotionStatus.innerHTML = `
                            <div>Advanced Scan Complete!</div>
                            <div class="emotion-badge ${emotionClass}">
                                ${detectedEmotion} <small>(${confidencePercent}% confidence)</small>
                            </div>
                            <div style="font-size: 0.8em; margin-top: 5px; display: flex; justify-content: space-around;">
                                <span style="color: #4caf50;">Happy: ${Math.round(emotions.happy)}%</span>
                                <span style="color: #2196f3;">Sad: ${Math.round(emotions.sad)}%</span>
                                <span style="color: #f44336;">Angry: ${Math.round(emotions.angry)}%</span>
                            </div>
                        `;
                        
                        // Show recommendations based on emotion
                        emotionRecommendation.style.display = 'block';
                        
                        let recommendation = '';
                        switch(detectedEmotion.toLowerCase()) {
                            case 'happy':
                            case 'very happy':
                                recommendation = "It's great to see you're feeling happy! This is an ideal time to engage with our community features or challenge yourself with new wellness activities.";
                                break;
                            case 'sad':
                            case 'very sad':
                                recommendation = "We notice you might be feeling down. Our support groups and mood-lifting resources are designed to help. Would you like to explore guided meditation or connect with a counselor?";
                                break;
                            case 'anxious':
                            case 'fear':
                                recommendation = "You appear to be experiencing some anxiety. Try our evidence-based breathing exercises in the Mindfulness Zone or chat with our AI assistant for immediate support.";
                                break;
                            case 'angry':
                            case 'very angry':
                                recommendation = "We detect signs of frustration. Our Stress Booster Games and Yoga Practice sections offer activities specifically designed to help manage these feelings.";
                                break;
                            case 'surprise':
                            case 'surprised':
                                recommendation = "You seem surprised! If you're feeling overwhelmed, our Resource Hub has expert information on managing unexpected emotions and situations effectively.";
                                break;
                            case 'disgust':
                            case 'disgusted':
                                recommendation = "You appear to be experiencing aversion. We have specialized mindfulness resources that can help you process these feelings in a constructive way.";
                                break;
                            case 'neutral':
                            case 'calm':
                                recommendation = "Your emotional state appears balanced. This is an excellent opportunity to explore new wellness practices or deepen existing ones.";
                                break;
                            case 'frustrated':
                                recommendation = "We detect signs of frustration - a mix of sadness and anger. Our conflict resolution resources and stress management exercises might be particularly helpful right now.";
                                break;
                            case 'excited':
                                recommendation = "You're showing signs of excitement! Channel this positive energy into our challenge activities or creative expression exercises.";
                                break;
                            case 'contempt':
                                recommendation = "Your expression suggests complex emotions. Our advanced reflection exercises and journaling prompts can help you explore these feelings more deeply.";
                                break;
                            default:
                                recommendation = "Thank you for using our advanced emotion scanner. Based on your current emotional state, we recommend exploring the features that resonate most with you right now.";
                        }
                        
                        emotionRecommendation.textContent = recommendation;
                        
                        // Store detailed emotion in session storage for personalized experience
                        sessionStorage.setItem('userEmotion', detectedEmotion.toLowerCase());
                        sessionStorage.setItem('emotionData', JSON.stringify(emotions));
                        
                        // Award extra points for using advanced emotion detection
                        updatePoints(35); // Increased from 25 for using the advanced feature
                    } else {
                        // No face detected
                        emotionStatus.innerHTML = '<strong>No face detected</strong>. Please ensure your face is clearly visible to the camera and well-lit.';
                        emotionRecommendation.style.display = 'none';
                        updatePoints(5); // Still give a few points for trying
                    }
                } catch (error) {
                    console.error('Error during emotion detection:', error);
                    emotionStatus.innerHTML = '<strong>Error during detection</strong>. Please try again or check your camera settings.';
                    emotionRecommendation.style.display = 'none';
                }
                
                // Update button
                startScanButton.disabled = false;
                startScanButton.textContent = 'Scan Again';
            }
            
            // Enhanced emotion detection function that considers multiple emotional signals
            function enhanceEmotionDetection(emotions) {
                // Refine emotion detection with specialized heuristics
                
                // Check for mixed emotional states
                if (emotions.happy > 30 && emotions.surprise > 30) {
                    return "Excited"; // Happy + Surprise = Excitement
                }
                
                if (emotions.sad > 30 && emotions.angry > 30) {
                    return "Frustrated"; // Sad + Angry = Frustration
                }
                
                if (emotions.angry > 50 && emotions.disgust > 20) {
                    return "Contempt"; // Strong anger + disgust can indicate contempt
                }
                
                if (emotions.sad > 40 && emotions.fear > 25) {
                    return "Anxious"; // Sadness + fear often indicates anxiety
                }
                
                if (emotions.neutral > 80) {
                    return "Calm"; // Very high neutral can be interpreted as calmness
                }
                
                if (emotions.happy > 60) {
                    return "Very Happy"; // Emphasize high happiness
                }
                
                if (emotions.sad > 60) {
                    return "Very Sad"; // Emphasize high sadness
                }
                
                if (emotions.angry > 60) {
                    return "Very Angry"; // Emphasize high anger
                }
                
                // If no special case detected, return null to use the default emotion
                return null;
            }
        }
    </script>
</body>
</html>
